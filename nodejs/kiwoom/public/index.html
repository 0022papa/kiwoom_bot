<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiwoom Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'fade-in-down': 'fadeInDown 0.5s ease-out',
                        'fade-out-up': 'fadeOutUp 0.5s ease-out forwards',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeInDown: { '0%': { opacity: '0', transform: 'translate(-50%, -20px)' }, '100%': { opacity: '1', transform: 'translate(-50%, 0)' } },
                        fadeOutUp: { '0%': { opacity: '1', transform: 'translate(-50%, 0)' }, '100%': { opacity: '0', transform: 'translate(-50%, -20px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .loader-white { border-top-color: white; animation: spin 1s linear infinite; border-width: 2px; border-style: solid; border-radius: 50%; width: 1rem; height: 1rem; border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent; display: inline-block; margin-right: 0.5rem; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .toggle-checkbox { right: calc(100% - 1.5rem); transition: all 0.3s; top: 0; border-color: #e2e8f0;}

        /* ì‹œìŠ¤í…œ ë¡œê·¸ ìŠ¤íƒ€ì¼ */
        .log-entry { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.8rem; border-bottom: 1px solid #333; padding: 2px 0; }
        .log-INFO { color: #d4d4d4; }
        .log-WARNING { color: #dcdcaa; }
        .log-ERROR { color: #f44747; font-weight: bold; }
        .log-DEBUG { color: #6a9955; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200">
    <div class="container mx-auto p-4 max-w-[1600px] relative">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">Kiwoom Bot</h1>
                <span id="mode-badge" class="px-2 py-1 text-xs font-bold rounded bg-gray-200 text-gray-600">Loading...</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/backtest.html" class="px-3 py-1.5 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors flex items-center gap-2">
                    <span class="hidden sm:inline">ë°±í…ŒìŠ¤íŒ…</span>
                </a>
                <button id="theme-toggle" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                    <svg id="theme-toggle-dark-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-1.414a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM3.05 13.657l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm.293-7.293l.707.707a1 1 0 011.414-1.414l-.707-.707a1 1 0 01-1.414 1.414z"></path></svg>
                </button>
                <button id="logout-button" class="px-3 py-1.5 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div id="message-box" class="hidden fixed top-10 left-1/2 transform -translate-x-1/2 z-50 min-w-[320px] max-w-md px-6 py-4 rounded-xl shadow-2xl font-bold text-sm md:text-base text-center animate-fade-in-down backdrop-blur-md border transition-all"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-6">

            <div class="space-y-6 lg:col-span-1"> 
                <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 transition-colors">
                    <h2 class="text-xl font-bold mb-4 flex items-center"><span>ìƒíƒœ ëª¨ë‹ˆí„°</span></h2>
                    <div class="mb-6">
                        <div id="status-container" class="flex flex-col items-center justify-center p-6 bg-slate-100 dark:bg-slate-700 rounded-xl transition-all duration-300 border-2 border-transparent">
                            <div id="status-light" class="w-6 h-6 rounded-full bg-gray-400 mb-2 shadow-lg transition-all duration-500"></div>
                            <span id="status-text" class="font-bold text-2xl tracking-tight transition-all duration-300">OFFLINE</span>
                            <span id="status-subtext" class="text-xs text-slate-500 dark:text-slate-400 mt-1">ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
                        </div>
                    </div>
                    
                    <form id="settings-form" class="space-y-4">
                        <div class="flex items-center justify-between p-3 mb-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-lg">
                            <div>
                                <label for="MOCK_TRADE" class="text-sm font-bold text-slate-800 dark:text-slate-200 cursor-pointer select-none">ëª¨ì˜íˆ¬ì ëª¨ë“œ</label>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">í•´ì œ ì‹œ <span class="text-red-500 font-bold">ì‹¤ì „ íˆ¬ì</span></p>
                            </div>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="MOCK_TRADE" id="MOCK_TRADE" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="MOCK_TRADE" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                            <label for="USE_MARKET_TIME" class="text-sm font-medium text-slate-700 dark:text-slate-300 cursor-pointer select-none">ì¥ ìš´ì˜ì‹œê°„ ì¤€ìˆ˜</label>
                            <input type="checkbox" id="USE_MARKET_TIME" name="USE_MARKET_TIME" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                            <div><label for="USE_AUTO_SELL" class="text-sm font-bold text-slate-700 dark:text-slate-200 cursor-pointer select-none">ë§¤ë„ ê°ì‹œ ì‹¤í–‰</label></div>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="USE_AUTO_SELL" id="USE_AUTO_SELL" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="USE_AUTO_SELL" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                            <div>
                                <label for="USE_AI_STOP_LOSS" class="text-sm font-bold text-slate-700 dark:text-slate-200 cursor-pointer select-none">AI ì†ì ˆê°€ ì ìš©</label>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">OFF ì‹œ ì„¤ì •ê°’ ì‚¬ìš©</p>
                            </div>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="USE_AI_STOP_LOSS" id="USE_AI_STOP_LOSS" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="USE_AI_STOP_LOSS" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                            <div><label for="USE_TELEGRAM" class="text-sm font-bold text-slate-700 dark:text-slate-200 cursor-pointer select-none">í…”ë ˆê·¸ë¨ ì•Œë¦¼</label></div>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="USE_TELEGRAM" id="USE_TELEGRAM" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="USE_TELEGRAM" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-100 dark:bg-slate-900/50 rounded-lg border border-gray-300 dark:border-slate-600">
                            <div><label for="DEBUG_MODE" class="text-sm font-bold text-slate-700 dark:text-slate-200 cursor-pointer select-none">ğŸ•µï¸ ë””ë²„ê·¸ ëª¨ë“œ</label></div>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="DEBUG_MODE" id="DEBUG_MODE" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="DEBUG_MODE" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="border border-blue-200 dark:border-blue-800 rounded-lg p-3 bg-blue-50 dark:bg-blue-900/20 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <label for="USE_SCHEDULER" class="text-sm font-bold text-blue-800 dark:text-blue-200 cursor-pointer select-none">â° ì˜¤ì „/ì ì‹¬/ì˜¤í›„ ë³€ê²½</label>
                                </div>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="USE_SCHEDULER" id="USE_SCHEDULER" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="USE_SCHEDULER" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div id="scheduler-options" class="grid grid-cols-2 gap-3 text-sm hidden mt-3 border-t border-blue-200 dark:border-blue-700 pt-3">
                                <div class="col-span-1"><label class="block text-xs text-slate-500 mb-1">ì˜¤ì „ ì‹œì‘</label><input type="time" id="MORNING_START" name="MORNING_START" class="w-full p-1.5 border rounded text-xs bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"></div>
                                <div class="col-span-1"><label class="block text-xs text-slate-500 mb-1">ì˜¤ì „ ì¡°ê±´ì‹</label><select id="MORNING_COND" name="MORNING_COND" class="w-full p-1.5 border rounded text-xs bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"></select></div>
                                
                                <div class="col-span-1"><label class="block text-xs text-slate-500 mb-1">ì ì‹¬(ì¤‘ê°„) ì‹œì‘</label><input type="time" id="LUNCH_START" name="LUNCH_START" class="w-full p-1.5 border rounded text-xs bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"></div>
                                <div class="col-span-1"><label class="block text-xs text-slate-500 mb-1">ì ì‹¬ ì¡°ê±´ì‹</label><select id="LUNCH_COND" name="LUNCH_COND" class="w-full p-1.5 border rounded text-xs bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"></select></div>

                                <div class="col-span-1"><label class="block text-xs text-slate-500 mb-1">ì˜¤í›„ ì‹œì‘</label><input type="time" id="AFTERNOON_START" name="AFTERNOON_START" class="w-full p-1.5 border rounded text-xs bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"></div>
                                <div class="col-span-1"><label class="block text-xs text-slate-500 mb-1">ì˜¤í›„ ì¡°ê±´ì‹</label><select id="AFTERNOON_COND" name="AFTERNOON_COND" class="w-full p-1.5 border rounded text-xs bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"></select></div>
                            </div>
                            <div id="manual-condition-box" class="mt-3 border-t border-blue-200 dark:border-blue-700 pt-3">
                                <label for="CONDITION_ID" class="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-400">í˜„ì¬ ì¡°ê±´ê²€ìƒ‰ì‹</label>
                                <select id="CONDITION_ID" name="CONDITION_ID" class="w-full p-2.5 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-colors"><option value="">ë¡œë”© ì¤‘...</option></select>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label for="BOT_STATUS" class="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-400">ë´‡ ìƒíƒœ ì„¤ì •</label>
                            <select id="BOT_STATUS" name="BOT_STATUS" class="w-full p-2.5 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
                                <option value="RUNNING">RUNNING (ë§¤ìˆ˜ ì‹¤í–‰)</option>
                                <option value="STOPPED">STOPPED (ë§¤ìˆ˜ ì¤‘ì§€)</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-400">1íšŒ ë§¤ìˆ˜(ì›)</label><input type="number" id="ORDER_AMOUNT" name="ORDER_AMOUNT" class="w-full p-2.5 border rounded-lg bg-slate-50 dark:bg-slate-700"></div>
                            <div><label class="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-400">ì¿¨ë‹¤ìš´(ë¶„)</label><input type="number" id="RE_ENTRY_COOLDOWN_MIN" name="RE_ENTRY_COOLDOWN_MIN" class="w-full p-2.5 border rounded-lg bg-slate-50 dark:bg-slate-700"></div>
                        </div>

                        <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600">
                            <label for="MIN_BUY_SELL_RATIO" class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-1">í˜¸ê°€ ë¹„ìœ¨ í•„í„°</label>
                            <input type="number" step="0.1" min="0" id="MIN_BUY_SELL_RATIO" name="MIN_BUY_SELL_RATIO" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-800 text-sm">
                            <p class="text-xs text-slate-500 mt-1">ê¸°ë³¸ê°’ 0.5 (ë†’ì„ìˆ˜ë¡ ì•ˆì „)</p>
                        </div>

                        <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-700/50">
                            <label for="OVERNIGHT_COND_IDS" class="block text-sm font-bold text-purple-800 dark:text-purple-200 mb-1">ì˜¤ë²„ë‚˜ì‡ ì¡°ê±´ì‹</label>
                            <input type="text" id="OVERNIGHT_COND_IDS" name="OVERNIGHT_COND_IDS" placeholder="ì˜ˆ: 2, 5" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-800 text-sm">
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                             <div><label class="block text-xs font-medium mb-1 text-red-500">ì†ì ˆ(%)</label><input type="number" step="0.1" id="STOP_LOSS_RATE" name="STOP_LOSS_RATE" class="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700 text-sm"></div>
                            <div><label class="block text-xs font-medium mb-1 text-green-500">ìµì ˆì‹œì‘(%)</label><input type="number" step="0.1" id="TRAILING_START_RATE" name="TRAILING_START_RATE" class="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700 text-sm"></div>
                            <div><label class="block text-xs font-medium mb-1 text-orange-500">íŠ¸ë ˆì¼ë§(%)</label><input type="number" step="0.1" id="TRAILING_STOP_RATE" name="TRAILING_STOP_RATE" class="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700 text-sm"></div>
                        </div>
                        <button type="submit" class="w-full p-3 mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md">ì„¤ì • ì €ì¥</button>
                    </form>
                </div>
            </div> 

            <div class="space-y-6 lg:col-span-1">
                <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 transition-colors">
                    <h2 class="text-xl font-bold mb-4">ì„¤ì • ìš”ì•½</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50 border-l-4 border-slate-300 dark:border-slate-500">
                            <span class="text-slate-600 dark:text-slate-300">ìš´ìš© ëª¨ë“œ / ìƒíƒœ</span>
                            <div class="flex items-center gap-2"><span id="display_MOCK_TRADE" class="font-bold">...</span><span class="text-slate-300">|</span><span id="display_BOT_STATUS" class="font-bold">...</span></div>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50 border-l-4 border-slate-300 dark:border-slate-500">
                            <span class="text-slate-600 dark:text-slate-300">ì‹œê°„ì¤€ìˆ˜ / ë§¤ë„ê°ì‹œ</span>
                            <div class="flex items-center gap-2"><span id="display_USE_MARKET_TIME" class="font-bold">...</span><span class="text-slate-300">|</span><span id="display_USE_AUTO_SELL" class="font-bold">...</span></div>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">AI ì†ì ˆê°€ ì‚¬ìš©</span><span id="display_USE_AI_STOP_LOSS" class="font-bold">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">ì•Œë¦¼ / ë””ë²„ê·¸</span>
                            <div class="flex items-center gap-2"><span id="display_USE_TELEGRAM" class="font-bold">...</span><span class="text-slate-300">|</span><span id="display_DEBUG_MODE" class="font-bold">...</span></div>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">ìë™ ìŠ¤ì¼€ì¤„</span><span id="display_USE_SCHEDULER" class="font-bold">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">í˜„ì¬ ì¡°ê±´ê²€ìƒ‰ì‹</span><span id="display_CONDITION_NAME" class="font-bold text-blue-600 dark:text-blue-400 truncate max-w-[150px]">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">1íšŒ ë§¤ìˆ˜</span><span id="display_ORDER_AMOUNT" class="font-bold text-slate-900 dark:text-slate-100">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">ì¬ì§„ì… ì¿¨íƒ€ì„</span><span id="display_RE_ENTRY_COOLDOWN_MIN" class="font-bold text-slate-900 dark:text-slate-100">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">í˜¸ê°€ ë¹„ìœ¨ í•„í„°</span><span id="display_MIN_BUY_SELL_RATIO" class="font-bold text-slate-900 dark:text-slate-100">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">ì˜¤ë²„ë‚˜ì‡ ì¡°ê±´ì‹</span><span id="display_OVERNIGHT_COND_IDS" class="font-bold text-purple-600 dark:text-purple-400">...</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded bg-slate-50 dark:bg-slate-700/50">
                            <span class="text-slate-600 dark:text-slate-300">ì†ì ˆ / ìµì ˆ / ì¶”ì </span>
                            <div class="space-x-1"><span id="display_STOP_LOSS_RATE" class="font-bold text-red-500">...</span> / <span id="display_TRAILING_START_RATE" class="font-bold text-green-500">...</span> / <span id="display_TRAILING_STOP_RATE" class="font-bold text-orange-500">...</span></div>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 transition-colors">
                    <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
                        <span class="flex items-center gap-2">
                            ğŸ“¡ ì‹¤ì‹œê°„ í¬ì°©
                            <span class="relative flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                        </span>
                        <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm" id="detected-count">0</span>
                    </h2>
                    <div class="overflow-y-auto max-h-[230px] border border-slate-200 dark:border-slate-700 rounded-lg">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-700 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300">ì‹œê°„</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300">ì¢…ëª©ëª…</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300">ì½”ë“œ</th>
                                </tr>
                            </thead>
                            <tbody id="detected-stocks-table" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                <tr><td colspan="3" class="px-4 py-4 text-center text-slate-500 text-sm">ëŒ€ê¸° ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 lg:col-span-1 xl:col-span-2 flex flex-col transition-colors">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-slate-100">
                            ë³´ìœ  ì¢…ëª©
                            <span class="px-2.5 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-xs font-bold" id="stock-count">0</span>
                        </h2>
                    </div>

                    <div class="flex items-center gap-3 w-full sm:w-auto justify-end">
                        <div class="hidden sm:flex items-center gap-3 px-3 py-1.5 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600">
                            <div class="text-right">
                                <div class="text-[10px] text-slate-400 font-semibold uppercase">ì‹¤í˜„ì†ìµ</div>
                                <div id="realized-profit-val" class="text-xs font-bold font-mono">-</div>
                            </div>
                            <div class="w-px h-6 bg-slate-200 dark:bg-slate-600"></div>

                            <div class="text-right">
                                <div class="text-[10px] text-slate-400 font-semibold uppercase">í‰ê°€ì†ìµ</div>
                                <div id="total-profit-val" class="text-xs font-bold font-mono">-</div>
                            </div>
                            <div class="w-px h-6 bg-slate-200 dark:bg-slate-600"></div>
                            <div class="text-right">
                                <div class="text-[10px] text-slate-400 font-semibold uppercase">ìˆ˜ìµë¥ </div>
                                <div id="total-rate-val" class="text-xs font-bold font-mono">-</div>
                            </div>
                        </div>

                        <button onclick="requestBulkSell()" title="ë¹„ìƒ! ì¼ê´„ ì²­ì‚° (ëª¨ë‘ ë§¤ë„)" class="group p-2.5 bg-white dark:bg-slate-800 border border-red-200 dark:border-red-900/50 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 hover:border-red-300 transition-all shadow-sm active:scale-95">
                            <svg class="w-5 h-5 text-red-500 group-hover:text-red-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto flex-grow">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-700 transition-colors">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-300">ì¢…ëª©</th>
                                <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-300">ìˆ˜ìµë¥ /ì†ìµ</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-300">í‰ê°€ê¸ˆ/ìˆ˜ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody id="trading-state-table" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <tr><td colspan="3" class="px-4 py-10 text-center text-slate-500">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 lg:col-span-3 xl:col-span-4 transition-colors">
                
                <div class="flex justify-between items-center mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">
                    <div class="flex space-x-6">
                        <button id="tab-btn-trades" onclick="switchTab('trades')" class="text-xl font-bold flex items-center gap-2 text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400 pb-2 transition-colors">
                            ë§¤ë§¤ ê¸°ë¡ <span class="text-sm font-normal text-slate-500">(ìµœê·¼ <span id="trade-count">0</span>ê±´)</span>
                        </button>
                        <button id="tab-btn-logs" onclick="switchTab('logs')" class="text-xl font-bold flex items-center gap-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 pb-2 transition-colors">
                            ì‹œìŠ¤í…œ ë¡œê·¸
                        </button>
                    </div>
                    
                    <button id="refresh-trades-btn" class="p-2 text-slate-400 hover:text-blue-500 dark:hover:text-blue-400 bg-transparent hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500" title="ìƒˆë¡œê³ ì¹¨">
                        <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>

                <div id="tab-content-trades" class="w-full h-80 overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 relative">
                        <thead class="hidden"><tr><th></th></tr></thead>
                        <tbody id="trades-table-body" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800 transition-colors">
                            <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ë§¤ë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="tab-content-logs" class="hidden w-full h-80 overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg bg-[#1e1e1e] p-4 font-mono text-sm text-[#d4d4d4]">
                    <div id="system-log-container" class="space-y-1">
                        <div class="text-center text-gray-500 mt-10">ë¡œê·¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

            </div>
        </div> 
    </div>

    <script>
        // ... (ê¸°ì¡´ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ë“± ìœ ì§€) ...
        const formatNum = (num) => new Intl.NumberFormat('ko-KR').format(num);
        const formatRate = (rate) => {
            const num = parseFloat(rate).toFixed(2);
            const twColor = num > 0 ? 'text-red-500' : (num < 0 ? 'text-blue-500' : 'text-slate-800 dark:text-slate-200');
            return `<span class="${twColor} font-bold">${num}%</span>`;
        };

        // --- íƒ­ ì „í™˜ í•¨ìˆ˜ ---
        let currentTab = 'trades';
        function switchTab(tabName) {
            currentTab = tabName;
            const tradesBtn = document.getElementById('tab-btn-trades');
            const logsBtn = document.getElementById('tab-btn-logs');
            const tradesContent = document.getElementById('tab-content-trades');
            const logsContent = document.getElementById('tab-content-logs');

            const activeClass = "text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400 text-slate-800 dark:text-slate-100";
            const inactiveClass = "text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 border-b-0";

            if (tabName === 'trades') {
                tradesBtn.className = `text-xl font-bold flex items-center gap-2 pb-2 transition-colors ${activeClass}`;
                logsBtn.className = `text-xl font-bold flex items-center gap-2 pb-2 transition-colors ${inactiveClass}`;
                tradesContent.classList.remove('hidden');
                logsContent.classList.add('hidden');
            } else {
                logsBtn.className = `text-xl font-bold flex items-center gap-2 pb-2 transition-colors ${activeClass}`;
                tradesBtn.className = `text-xl font-bold flex items-center gap-2 pb-2 transition-colors ${inactiveClass}`;
                logsContent.classList.remove('hidden');
                tradesContent.classList.add('hidden');
                loadSystemLogs(); // íƒ­ ì „í™˜ ì‹œ ë¡œê·¸ ë¡œë“œ
            }
        }

        async function requestBulkSell() {
            if (!confirm("ğŸš¨ ì •ë§ë¡œ ëª¨ë“  ë³´ìœ  ì¢…ëª©ì„ ì‹œì¥ê°€ë¡œ ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)")) {
                return;
            }
            try {
                const response = await fetchAPI('/api/bulk_sell', { method: 'POST' });
                if (response && response.success) {
                    showMessage("ğŸš¨ ì¼ê´„ ì²­ì‚° ëª…ë ¹ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                } else {
                    showMessage("ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨", "error");
                }
            } catch (e) {
                showMessage("í†µì‹  ì˜¤ë¥˜ ë°œìƒ", "error");
            }
        }

        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        function setTheme(isDark) {
            if (isDark) { document.documentElement.classList.add('dark'); lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden'); } 
            else { document.documentElement.classList.remove('dark'); darkIcon.classList.remove('hidden'); lightIcon.classList.add('hidden'); }
        }
        const isDarkMode = localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
        setTheme(isDarkMode);

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            setTheme(!isDark);
            localStorage.setItem('color-theme', !isDark ? 'dark' : 'light');
        });

        async function fetchAPI(url, options = {}) {
            try {
                const cacheBuster = url.includes('?') ? `&t=${Date.now()}` : `?t=${Date.now()}`;
                const response = await fetch(url + cacheBuster, options);
                if (response.status === 401) { window.location.href = '/login.html'; return null; }
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                return await response.json();
            } catch (error) { return null; }
        }

        const settingsForm = document.getElementById('settings-form');
        const saveButton = settingsForm.querySelector('button[type="submit"]');
        const originalButtonText = saveButton.innerHTML; 
        const statusContainer = document.getElementById('status-container');
        const statusLight = document.getElementById('status-light');
        const statusText = document.getElementById('status-text');
        const statusSubtext = document.getElementById('status-subtext');
        const messageBox = document.getElementById('message-box');
        const tradingStateTable = document.getElementById('trading-state-table');
        const stockCount = document.getElementById('stock-count');
        const tradesTableBody = document.getElementById('trades-table-body');
        const tradeCount = document.getElementById('trade-count');
        const detectedTableBody = document.getElementById('detected-stocks-table');
        const detectedCount = document.getElementById('detected-count');
        const totalProfitVal = document.getElementById('total-profit-val');
        const totalRateVal = document.getElementById('total-rate-val');
        const realizedProfitVal = document.getElementById('realized-profit-val'); 

        let lastTradeCount = -1; 
        
        const schedulerCheck = document.getElementById('USE_SCHEDULER');
        const schedulerOptions = document.getElementById('scheduler-options');
        const manualConditionBox = document.getElementById('manual-condition-box');

        function toggleSchedulerUI() {
            if (schedulerCheck.checked) {
                schedulerOptions.classList.remove('hidden');
                manualConditionBox.classList.add('hidden');
            } else {
                schedulerOptions.classList.add('hidden');
                manualConditionBox.classList.remove('hidden');
            }
        }
        schedulerCheck.addEventListener('change', toggleSchedulerUI);

        async function updateBotStatus() {
            const data = await fetchAPI('/api/status'); 
            if (data) {
                let status = data.bot_status || "OFFLINE";
                let activeMode = data.active_mode || "";
                let isOffline = data.is_offline;
                let lastSyncAgo = data.last_sync_ago || 999;

                const summaryStatus = document.getElementById('display_BOT_STATUS');

                if (isOffline || status === 'OFFLINE') {
                    statusContainer.className = "flex flex-col items-center justify-center p-6 bg-slate-200 dark:bg-slate-700 rounded-xl transition-all duration-300 border-2 border-slate-300 dark:border-slate-600";
                    statusLight.className = "w-6 h-6 rounded-full bg-slate-500 mb-2 shadow-lg";
                    statusText.textContent = "â›” ì—°ê²° ëŠê¹€";
                    statusText.className = "font-bold text-2xl tracking-tight text-slate-500 dark:text-slate-400";
                    statusSubtext.textContent = `ë§ˆì§€ë§‰ ì‘ë‹µ: ${lastSyncAgo}ì´ˆ ì „`;
                    if(summaryStatus) summaryStatus.innerHTML = '<span class="text-slate-500 font-bold">â›” OFFLINE</span>';
                
                } else if (status === 'SLEEPING') {
                    statusContainer.className = "flex flex-col items-center justify-center p-6 bg-purple-50 dark:bg-purple-900/20 rounded-xl transition-all duration-300 border-2 border-purple-200 dark:border-purple-800";
                    statusLight.className = "w-6 h-6 rounded-full bg-purple-500 mb-2 shadow-[0_0_15px_rgba(168,85,247,0.5)]";
                    statusText.textContent = "ğŸŒ™ ì¥ ë§ˆê° ëŒ€ê¸°";
                    statusText.className = "font-bold text-2xl tracking-tight text-purple-600 dark:text-purple-400";
                    statusSubtext.textContent = "ë´‡ì´ íœ´ì‹ ì¤‘ì…ë‹ˆë‹¤ (ë§¤ë„ ê°ì‹œ ì¤‘)";
                    if(summaryStatus) summaryStatus.innerHTML = '<span class="text-purple-600 font-bold">ğŸŒ™ ëŒ€ê¸° ëª¨ë“œ</span>';

                } else if (status === 'RUNNING') {
                    statusContainer.className = "flex flex-col items-center justify-center p-6 bg-green-50 dark:bg-green-900/20 rounded-xl transition-all duration-300 border-2 border-green-200 dark:border-green-800";
                    statusLight.className = "w-6 h-6 rounded-full bg-green-500 mb-2 shadow-[0_0_15px_rgba(34,197,94,0.6)] animate-pulse-fast";
                    statusText.textContent = "âš¡ ê°€ë™ ì¤‘";
                    statusText.className = "font-bold text-2xl tracking-tight text-green-600 dark:text-green-400";
                    statusSubtext.textContent = "ì‹¤ì‹œê°„ ë§¤ë§¤ ê°ì‹œ ì¤‘ì…ë‹ˆë‹¤";
                    if(summaryStatus) summaryStatus.innerHTML = '<span class="text-green-600 font-bold">âš¡ ê°€ë™ ì¤‘</span>';

                } else {
                    statusContainer.className = "flex flex-col items-center justify-center p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl transition-all duration-300 border-2 border-yellow-200 dark:border-yellow-800";
                    statusLight.className = "w-6 h-6 rounded-full bg-yellow-500 mb-2 shadow-lg";
                    statusText.textContent = "â¸ ëŒ€ê¸° ì¤‘";
                    statusText.className = "font-bold text-2xl tracking-tight text-yellow-600 dark:text-yellow-400";
                    statusSubtext.textContent = "ë§¤ìˆ˜ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤";
                    if(summaryStatus) summaryStatus.innerHTML = '<span class="text-yellow-500 font-bold">â¸ ì •ì§€ë¨</span>';
                }

                const badge = document.getElementById('mode-badge');
                if (data.active_mode === 'REAL' || (activeMode && activeMode.includes('REAL'))) {
                    badge.textContent = "ğŸ”´ ì‹¤ì „íˆ¬ì";
                    badge.className = "px-2 py-1 text-xs font-bold rounded bg-red-100 text-red-600 border border-red-200 animate-pulse shadow-sm";
                } else {
                    badge.textContent = "ğŸŸ¢ ëª¨ì˜íˆ¬ì";
                    badge.className = "px-2 py-1 text-xs font-bold rounded bg-green-100 text-green-600 border border-green-200 shadow-sm";
                }
                
                updateTradingStateTable(data.trading_state);
                
                if (data.account_summary) {
                    const sum = data.account_summary;
                    const rp = sum.realized_profit || 0;
                    const rpClass = rp > 0 ? 'text-red-500' : (rp < 0 ? 'text-blue-500' : 'text-slate-500');
                    realizedProfitVal.textContent = rp.toLocaleString() + 'ì›';
                    realizedProfitVal.className = `text-xs font-bold font-mono ${rpClass}`;

                    const profitClass = sum.total_profit > 0 ? 'text-red-500' : (sum.total_profit < 0 ? 'text-blue-500' : 'text-slate-500');
                    totalProfitVal.textContent = sum.total_profit.toLocaleString() + 'ì›';
                    totalProfitVal.className = `text-xs font-bold font-mono ${profitClass}`;
                    
                    totalRateVal.textContent = sum.total_rate.toFixed(2) + '%';
                    totalRateVal.className = `text-xs font-bold font-mono ${profitClass}`;
                } else {
                    realizedProfitVal.textContent = '-';
                    totalProfitVal.textContent = '-';
                    totalRateVal.textContent = '-';
                }
            }
        }

        function updateTradingStateTable(state) {
            tradingStateTable.innerHTML = '';
            const stocks = state || {};
            const keys = Object.keys(stocks);
            stockCount.textContent = keys.length;

            if (keys.length === 0) {
                tradingStateTable.innerHTML = '<tr><td colspan="3" class="px-4 py-10 text-center text-slate-500">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            keys.forEach(stockCode => {
                const data = stocks[stockCode];
                const profitRate = data.current_profit_rate || 0;
                const totalBuyAmt = data.buy_price * data.buy_qty;
                const profitAmt = Math.floor(totalBuyAmt * (profitRate / 100));
                const profitAmtStr = profitAmt.toLocaleString();
                const sign = profitAmt > 0 ? "+" : "";

                let profitClass = profitRate > 0 ? 'text-red-500' : (profitRate < 0 ? 'text-blue-500' : 'text-slate-500');
                const strategy = data.applied_strategy || { sl: '-', ts_start: '-', ts_stop: '-' };

                const row = `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors border-b border-slate-100 dark:border-slate-700">
                        <td class="px-4 py-3">
                            <div class="font-bold text-slate-700 dark:text-slate-200">${data.stk_nm || stockCode}</div>
                            <div class="text-xs text-slate-400 font-mono">${stockCode}</div>
                            <div class="text-[10px] text-blue-500 mt-1">${data.condition_from || 'ì•Œìˆ˜ì—†ìŒ'}</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="text-base font-bold ${profitClass}">${profitRate.toFixed(2)}%</div>
                            <div class="text-xs font-bold ${profitClass} mt-0.5">${sign}${profitAmtStr}ì›</div>
                            <div class="text-xs text-slate-500 mt-1"><span class="px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-600">${data.status || 'ëŒ€ê¸°'}</span></div>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="text-sm font-medium text-slate-700 dark:text-slate-300">${(data.buy_price * data.buy_qty).toLocaleString()}ì›</div>
                            <div class="text-xs text-slate-400 mb-1">${data.buy_qty}ì£¼ / í‰ë‹¨ ${(data.buy_price).toLocaleString()}</div>
                            <div class="text-[10px] text-slate-400 bg-slate-100 dark:bg-slate-800 rounded px-1 py-0.5 inline-block">
                                SL ${strategy.sl}% | TS ${strategy.ts_start}% / ${strategy.ts_stop}%
                            </div>
                        </td>
                    </tr>`;
                tradingStateTable.innerHTML += row;
            });
        }

        async function updateDetectedStocks() {
            const data = await fetchAPI('/api/current_conditions');
            detectedTableBody.innerHTML = '';
            if (data && data.stocks && data.stocks.length > 0) {
                detectedCount.textContent = data.stocks.length;
                data.stocks.forEach(stock => {
                    const row = `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                            <td class="px-4 py-2 text-sm text-slate-500">${stock.time}</td>
                            <td class="px-4 py-2 text-sm font-bold text-slate-700 dark:text-slate-200">${stock.name}</td>
                            <td class="px-4 py-2 text-sm text-slate-400 text-xs">${stock.code}</td>
                        </tr>`;
                    detectedTableBody.innerHTML += row;
                });
            } else { detectedCount.textContent = 0; detectedTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-slate-500 text-sm">í˜„ì¬ í¬ì°©ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; }
        }

        async function loadSettings(onlySummary = false) {
            const data = await fetchAPI('/api/settings');
            if (data) {
                if (!onlySummary) {
                    Object.keys(data).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = data[key] !== false;
                                if(key === 'USE_SCHEDULER') toggleSchedulerUI();
                            }
                            else el.value = data[key];
                        }
                    });
                }
                
                const simpleMappings = {
                    MOCK_TRADE: val => val ? '<span class="text-green-600">ğŸŸ¢ ëª¨ì˜íˆ¬ì</span>' : '<span class="text-red-600 animate-pulse">ğŸ”´ ì‹¤ì „íˆ¬ì</span>',
                    USE_MARKET_TIME: val => val ? '<span class="font-bold text-slate-700 dark:text-slate-200">â° 09:00~15:30</span>' : '<span class="font-bold text-purple-500">ğŸŒ™ 24ì‹œê°„</span>',
                    USE_AUTO_SELL: val => val ? '<span class="font-bold text-blue-600">ğŸ›¡ï¸ ê°ì‹œ ON</span>' : '<span class="font-bold text-red-500">âš ï¸ ê°ì‹œ OFF</span>',
                    USE_TELEGRAM: val => val ? '<span class="font-bold text-blue-500">ğŸ”” ON</span>' : '<span class="font-bold text-slate-400">ğŸ”• OFF</span>',
                    DEBUG_MODE: val => val ? '<span class="font-bold text-orange-500">ğŸ•µï¸ ON</span>' : '<span class="font-bold text-slate-400">ğŸ”’ OFF</span>',
                    USE_SCHEDULER: val => val ? '<span class="font-bold text-blue-500">â° ON</span>' : '<span class="font-bold text-slate-400">OFF</span>',
                    // ğŸŒŸ [ì‹ ê·œ] AI ì†ì ˆê°€ í‘œì‹œ ë§µí•‘
                    USE_AI_STOP_LOSS: val => val ? '<span class="font-bold text-indigo-500">ğŸ¤– AI ì ìš©</span>' : '<span class="font-bold text-slate-400">âš™ï¸ ì„¤ì •ê°’</span>',
                    ORDER_AMOUNT: val => val.toLocaleString() + ' ì›',
                    STOP_LOSS_RATE: val => val + ' %',
                    TRAILING_START_RATE: val => val + ' %',
                    TRAILING_STOP_RATE: val => val + ' %',
                    RE_ENTRY_COOLDOWN_MIN: val => val + ' ë¶„',
                    OVERNIGHT_COND_IDS: val => val 
                };

                for (const [key, formatter] of Object.entries(simpleMappings)) {
                    const el = document.getElementById('display_' + key);
                    if (el && data[key] !== undefined) el.innerHTML = formatter(data[key]);
                }

                const condEl = document.getElementById('display_CONDITION_NAME');
                const select = document.getElementById('CONDITION_ID');
                let condName = data.CONDITION_ID || "ì„ íƒ ì•ˆë¨";
                if (select.options.length > 0) {
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value == data.CONDITION_ID) { condName = select.options[i].text; break; }
                    }
                }
                condEl.textContent = condName;
                
                const hogaEl = document.getElementById('display_MIN_BUY_SELL_RATIO');
                if(hogaEl && data.MIN_BUY_SELL_RATIO !== undefined) {
                    hogaEl.innerHTML = `<strong>${data.MIN_BUY_SELL_RATIO}</strong> <span class="text-xs text-slate-400">(${data.MIN_BUY_SELL_RATIO >= 1 ? 'ë³´ìˆ˜ì ' : 'ê³µê²©ì '})</span>`;
                }
            }
        }

        async function loadConditions() {
            const data = await fetchAPI('/api/conditions');
            const selectEl = document.getElementById('CONDITION_ID');
            const morningSelect = document.getElementById('MORNING_COND');
            const lunchSelect = document.getElementById('LUNCH_COND');
            const afternoonSelect = document.getElementById('AFTERNOON_COND');
            
            [selectEl, morningSelect, lunchSelect, afternoonSelect].forEach(el => el.innerHTML = ''); 

            if (data && data.conditions && data.conditions.length > 0) {
                data.conditions.forEach(cond => {
                    const option = document.createElement('option');
                    option.value = cond.id;
                    option.textContent = `${cond.name} (${cond.id})`;
                    
                    selectEl.appendChild(option.cloneNode(true));
                    morningSelect.appendChild(option.cloneNode(true));
                    lunchSelect.appendChild(option.cloneNode(true));
                    afternoonSelect.appendChild(option.cloneNode(true));
                });
                loadSettings(); 
            } else { 
                const opt = '<option value="">ì¡°ê±´ê²€ìƒ‰ì‹ ì—†ìŒ</option>';
                [selectEl, morningSelect, lunchSelect, afternoonSelect].forEach(el => el.innerHTML = opt);
            }
        }
        
        async function loadTradesLog(forceUpdate = false) {
            const data = await fetchAPI('/api/trades');
            if (data && data.trades) {
                if (!forceUpdate && data.trades.length === lastTradeCount) return;
                lastTradeCount = data.trades.length;
                tradeCount.textContent = lastTradeCount;
                tradesTableBody.innerHTML = ''; 

                if (lastTradeCount > 0) {
                    data.trades.forEach(trade => {
                        const actionBadge = trade.action === 'BUY' 
                            ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300">ë§¤ìˆ˜</span>'
                            : (trade.action === 'SELL' 
                                ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300">ë§¤ë„</span>' 
                                : '<span class="px-2 py-0.5 rounded text-xs font-bold bg-gray-100 text-gray-600">ê¸°íƒ€</span>');
                        const profit = parseFloat(trade.profit_rate || 0); // profit -> profit_rateë¡œ ìˆ˜ì •
                        const profitColor = profit > 0 ? 'text-red-500' : (profit < 0 ? 'text-blue-500' : 'text-slate-400');
                        const profitText = trade.action === 'SELL' ? `<span class="font-bold ${profitColor}">${profit.toFixed(2)}%</span>` : '';
                        
                        // AI ë¶„ì„ ë‚´ìš© í‘œì‹œìš© (íˆ´íŒ í˜¹ì€ ë³„ë„ í‘œì‹œ)
                        let aiReasonHtml = '';
                        if (trade.ai_reason && trade.ai_reason !== 'None' && trade.ai_reason !== '') {
                            aiReasonHtml = `<div class="mt-1 text-xs text-indigo-500 dark:text-indigo-400 flex items-center gap-1" title="${trade.ai_reason}">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>
                                <span>AI ë¶„ì„: ${trade.ai_reason}</span>
                            </div>`;
                        }

                        const row = `
                            <tr class="border-b border-slate-100 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <td colspan="6" class="p-4">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex items-center gap-2">
                                            ${actionBadge}
                                            <span class="font-bold text-slate-800 dark:text-slate-200 text-sm md:text-base">${trade.stock_name}</span>
                                            <span class="text-xs text-slate-400">(${trade.stock_code || '-'})</span>
                                        </div>
                                        <div class="text-right">${profitText}</div>
                                    </div>
                                    <div class="flex justify-between items-center text-xs md:text-sm text-slate-500 dark:text-slate-400">
                                        <div class="flex gap-2 items-center">
                                            <span>${trade.timestamp.split(' ')[1]}</span>
                                            <span class="w-px h-3 bg-slate-300 dark:bg-slate-600"></span>
                                            <span>${parseInt(trade.price).toLocaleString()}ì›</span>
                                            <span class="text-slate-400">x ${trade.qty}</span>
                                        </div>
                                        <div class="truncate max-w-[120px] md:max-w-xs text-slate-400" title="${trade.reason}">${trade.reason}</div>
                                    </div>
                                    ${aiReasonHtml}
                                </td>
                            </tr>`;
                        tradesTableBody.innerHTML += row;
                    });
                } else { tradesTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ë§¤ë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; }
            }
        }

        async function loadSystemLogs() {
            try {
                const res = await fetchAPI('/api/logs');
                const data = res; 
                const container = document.getElementById('system-log-container');
                const scrollParent = container.parentElement;

                const isAtBottom = scrollParent.scrollHeight - scrollParent.scrollTop - scrollParent.clientHeight < 50;
                
                if (data && data.logs && data.logs.length > 0) {
                    const sortedLogs = [...data.logs].reverse(); 
                    const html = sortedLogs.map(log => {
                        const timeStr = log.timestamp.substring(5);
                        const levelClass = `log-${log.level}`;
                        return `
                            <div class="log-entry ${levelClass}">
                                <span class="text-blue-400 mr-2">[${timeStr}]</span>
                                <span class="font-bold mr-2">[${log.module}]</span>
                                ${log.message}
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = html;
                    
                    if (isAtBottom) {
                        scrollParent.scrollTop = scrollParent.scrollHeight;
                    }
                } else {
                    container.innerHTML = '<div class="text-center text-gray-500 mt-10">ë¡œê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (err) { 
                console.error("System Log Error:", err); 
            }
        }

        function showMessage(message, type = 'success') {
            messageBox.classList.remove('hidden', 'animate-fade-out-up');
            messageBox.className = `fixed top-10 left-1/2 transform -translate-x-1/2 z-50 min-w-[320px] max-w-md px-6 py-4 rounded-xl shadow-2xl font-bold text-sm md:text-base text-center animate-fade-in-down backdrop-blur-md border transition-all ${type === 'success' ? 'bg-green-600/95 text-white border-green-500' : 'bg-red-600/95 text-white border-red-500'}`;
            messageBox.textContent = message;
            setTimeout(() => { messageBox.classList.remove('animate-fade-in-down'); messageBox.classList.add('animate-fade-out-up'); setTimeout(() => messageBox.classList.add('hidden'), 500); }, 3000);
        }

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveButton.disabled = true;
            saveButton.innerHTML = `<span class="loader-white"></span> ì €ì¥ ì¤‘...`;
            const isMockCheck = document.getElementById('MOCK_TRADE').checked;
            const formData = new FormData(settingsForm);
            const settings = Object.fromEntries(formData.entries());
            
            settings.ORDER_AMOUNT = parseInt(settings.ORDER_AMOUNT);
            settings.STOP_LOSS_RATE = parseFloat(settings.STOP_LOSS_RATE);
            settings.TRAILING_START_RATE = parseFloat(settings.TRAILING_START_RATE);
            settings.TRAILING_STOP_RATE = parseFloat(settings.TRAILING_STOP_RATE);
            settings.RE_ENTRY_COOLDOWN_MIN = parseInt(settings.RE_ENTRY_COOLDOWN_MIN);
            settings.MIN_BUY_SELL_RATIO = parseFloat(settings.MIN_BUY_SELL_RATIO);
            
            settings.USE_MARKET_TIME = document.getElementById('USE_MARKET_TIME').checked;
            settings.USE_AUTO_SELL = document.getElementById('USE_AUTO_SELL').checked;
            settings.USE_TELEGRAM = document.getElementById('USE_TELEGRAM').checked;
            settings.DEBUG_MODE = document.getElementById('DEBUG_MODE').checked;
            settings.MOCK_TRADE = document.getElementById('MOCK_TRADE').checked;
            settings.USE_SCHEDULER = document.getElementById('USE_SCHEDULER').checked;
            
            // ğŸŒŸ [ì‹ ê·œ] AI ì†ì ˆê°€ í† ê¸€ ê°’ ì „ì†¡
            settings.USE_AI_STOP_LOSS = document.getElementById('USE_AI_STOP_LOSS').checked;

            if (!isMockCheck) {
                if (!confirm("âš ï¸ [ê²½ê³ ] 'ì‹¤ì „ íˆ¬ì' ëª¨ë“œì…ë‹ˆë‹¤!\nì •ë§ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    document.getElementById('MOCK_TRADE').checked = true;
                    saveButton.disabled = false; saveButton.innerHTML = originalButtonText; return; 
                }
            }
            try {
                await fetchAPI('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) });
                showMessage('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateBotStatus(); loadSettings(); 
            } catch (error) {} finally { saveButton.disabled = false; saveButton.innerHTML = originalButtonText; }
        });
        
        document.getElementById('logout-button').addEventListener('click', async () => { await fetchAPI('/api/logout', { method: 'POST' }); window.location.href = '/login.html'; });
        document.getElementById('refresh-trades-btn').addEventListener('click', async () => {
            const btn = document.getElementById('refresh-trades-btn'); const icon = document.getElementById('refresh-icon');
            btn.disabled = true; icon.classList.add('animate-spin', 'text-blue-600', 'dark:text-blue-400');
            
            if (currentTab === 'trades') {
                try { await Promise.all([ loadTradesLog(true), new Promise(resolve => setTimeout(resolve, 600)) ]); showMessage('ë§¤ë§¤ ê¸°ë¡ ê°±ì‹  ì™„ë£Œ', 'success'); } 
                catch (error) { showMessage('ê°±ì‹  ì‹¤íŒ¨', 'error'); } finally { icon.classList.remove('animate-spin', 'text-blue-600', 'dark:text-blue-400'); btn.disabled = false; }
            } else {
                try { await Promise.all([ loadSystemLogs(), new Promise(resolve => setTimeout(resolve, 600)) ]); showMessage('ì‹œìŠ¤í…œ ë¡œê·¸ ê°±ì‹  ì™„ë£Œ', 'success'); } 
                catch (error) { showMessage('ê°±ì‹  ì‹¤íŒ¨', 'error'); } finally { icon.classList.remove('animate-spin', 'text-blue-600', 'dark:text-blue-400'); btn.disabled = false; }
            }
        });

        function initializeDashboard() {
            loadConditions(); loadTradesLog(); updateBotStatus(); updateDetectedStocks();
            setInterval(() => { 
                updateBotStatus(); 
                if (currentTab === 'trades') loadTradesLog();
                else loadSystemLogs();
                updateDetectedStocks();
                loadSettings(true); 
            }, 3000); 
        }
        initializeDashboard();
    </script>
</body>
</html>